(()=>{"use strict";class e{static isDebug(){return!0}}class t{static id(e){return document.getElementById(e)}static class(e){return document.getElementsByClassName(e)}static attribute(e,t){return document.querySelector("["+e+'"'+t+'"]')}}function n(){return 0===window.getSelection().rangeCount?null:window.getSelection().getRangeAt(0).startContainer}function s(e,t=n()){try{return t.nodeType!==Node.TEXT_NODE&&t.hasAttribute(e)?t:s(e,t.parentElement)}catch(e){return null}}function i(e,t=n()){try{return e.includes(t.nodeName.toLowerCase())?t:i(e,t.parentElement)}catch(e){return null}}class r{static trigger(e,t){document.dispatchEvent(new CustomEvent(e,t))}static triggerCustom(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))}}class o{static string(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"){let n="";for(let s=0;s<e;s++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}static randInt(e,t,n=1){if(1===n)return Math.round(e+Math.random()*(t-e));let s=[];for(let i=0;i<n;i++)s.push(o.randInt(e,t,1));return s}}function a(e,t,n,s="#1e90ff"){const i=o.string(11),r=document.createElement("div");r.classList.add("alertCard"),r.style.backgroundColor=s,r.id=i,r.innerHTML="<h3>"+e+"</h3><p>"+t+"</p>",document.getElementById("body").appendChild(r),setTimeout((()=>{r.remove()}),n)}const c=[9,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,112,113,114,115,116,117,118,119,120,121,122,123,144,145,225];class u{static isExtra(e){return c.includes(e)}static ctrl(e){return window.navigator.platform.match("Mac")?e.metaKey:e.ctrlKey}}const l={generic:[{matches:{1:[{name:"keyword.operator",pattern:/\=|\+/g},{name:"keyword.dot",pattern:/\./g}],2:{name:"string",matches:{name:"constant.character.escape",pattern:/\\('|"){1}/g}}},pattern:/(\(|\s|\[|\=|:|\+|\.|\{|,)(('|")([^\\\1]|\\.)*?(\3))/gm},{name:"comment",pattern:/\/\*[\s\S]*?\*\/|(\/\/|\#)(?!.*('|").*?[^:](\/\/|\#)).*?$/gm},{name:"constant.numeric",pattern:/\b(\d+(\.\d+)?(e(\+|\-)?\d+)?(f|d)?|0x[\da-f]+)\b/gi},{matches:{1:"keyword"},pattern:/\b(and|array|as|b(ool(ean)?|reak)|c(ase|atch|har|lass|on(st|tinue))|d(ef|elete|o(uble)?)|e(cho|lse(if)?|xit|xtends|xcept)|f(inally|loat|or(each)?|unction)|global|if|import|int(eger)?|long|new|object|or|pr(int|ivate|otected)|public|return|self|st(ring|ruct|atic)|switch|th(en|is|row)|try|(un)?signed|var|void|while)(?=\b)/gi},{name:"constant.language",pattern:/true|false|null/g},{name:"keyword.operator",pattern:/\+|\!|\-|&(gt|lt|amp);|\||\*|\=/g},{matches:{1:"function.call"},pattern:/(\w+?)(?=\()/g},{matches:{1:"storage.function",2:"entity.name.function"},pattern:/(function)\s(.*?)(?=\()/g}],python:[{name:"variable.self",pattern:/self/g},{name:"constant.language",pattern:/None|True|False|NotImplemented|\.\.\./g},{name:"support.object",pattern:/object/g},{name:"support.function.python",pattern:/\b(bs|divmod|input|open|staticmethod|all|enumerate|int|ord|str|any|eval|isinstance|pow|sum|basestring|execfile|issubclass|print|super|bin|file|iter|property|tuple|bool|filter|len|range|type|bytearray|float|list|raw_input|unichr|callable|format|locals|reduce|unicode|chr|frozenset|long|reload|vars|classmethod|getattr|map|repr|xrange|cmp|globals|max|reversed|zip|compile|hasattr|memoryview|round|__import__|complex|hash|min|set|apply|delattr|help|next|setattr|buffer|dict|hex|object|slice|coerce|dir|id|oct|sorted|intern)(?=\()/g},{matches:{1:"keyword"},pattern:/\b(pass|lambda|with|is|not|in|from|elif|raise|del)(?=\b)/g},{matches:{1:"storage.class",2:"entity.name.class",3:"entity.other.inherited-class"},pattern:/(class)\s+(\w+)\((\w+?)\)/g},{matches:{1:"storage.function",2:"support.magic"},pattern:/(def)\s+(__\w+)(?=\()/g},{name:"support.magic",pattern:/__(name)__/g},{matches:{1:"keyword.control",2:"support.exception.type"},pattern:/(except) (\w+):/g},{matches:{1:"storage.function",2:"entity.name.function"},pattern:/(def)\s+(\w+)(?=\()/g},{name:"entity.name.function.decorator",pattern:/@([\w\.]+)/g},{name:"comment.docstring",pattern:/('{3}|"{3})[\s\S]*?\1/gm}]};function d(e,t,n,s){const i=s.substr(e);return n=n.replace(/\$/g,"$$$$"),s.substr(0,e)+i.replace(t,n)}function h(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort(((e,t)=>t-e))}function p(e,t,n,s){return n>=e&&n<t||s>e&&s<t}class g{constructor(e){this.patterns=e;const t={},n={};function s(e,t){return`<span class="${e.replace(/\./g," ")}">${t}</span>`}function i(e,i,r,o=0){let a=i.pattern;if(!a)return!1;const c=!a.global;a=function(e){let t="";return e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),new RegExp(e.source,t)}(a);const u=a.exec(r);if(!u)return!1;!i.name&&i.matches&&"string"==typeof i.matches[0]&&(i.name=i.matches[0],delete i.matches[0]);let l=u[0];const m=u.index+o,f=u[0].length+m;if(m===f)return!1;if(function(e,s){for(let c in n)if(c=parseInt(c,10),i=c,r=n[c],a=s,((o=e)!==i||a!==r)&&o<=i&&a>=r&&(delete n[c],delete t[c]),p(c,n[c],e,s))return!0;var i,r,o,a;return!1}(m,f))return{remaining:r.substr(f-o),offset:f};function y(e,t){const n=u[t];if(!n)return;const r=i.matches[t],o=r.language,a=r.name&&r.matches?r.matches:r,c=function(e,n,i){l=d(function(e,t){let n=0;for(let s=1;s<t;++s)e[s]&&(n+=e[s].length);return n}(u,t),e,i?s(i,n):n,l)};if("string"==typeof r)return void c(n,n,r);let h;const p=new g(e.patterns);if(o)return h=p.refract(n,o),void c(n,h);h=p.refract(n,void 0,a.length?a:[a]),c(n,h,r.matches?r.name:0)}const b=h(i.matches);for(const t of b)y(e,t);return w=l,i.name&&(w=s(i.name,w)),t[m]={replace:u[0],with:w},n[m]=f,!c&&{remaining:r.substr(f-o),offset:f};var w}this.refract=function(e){for(const t of this.patterns){let n=i(this,t,e);for(;n;)n=i(this,t,n.remaining,n.offset)}return function(e){const n=h(t);for(const s of n){const n=t[s];e=d(s,n.replace,n.with,e)}return e}(e)}}}class m{static createRange(e,t,n=null){if(n||((n=document.createRange()).selectNode(e),n.setStart(e,0)),0===t.count)n.setEnd(e,t.count);else if(e&&t.count>0)if(e.nodeType===Node.TEXT_NODE)e.textContent.length<t.count?t.count-=e.textContent.length:(n.setEnd(e,t.count),t.count=0);else for(let s=0;s<e.childNodes.length&&(n=m.createRange(e.childNodes[s],t,n),0!==t.count);s++);return n}static setPosition(e,t){if(t>=0){let n=document.getSelection(),s=m.createRange(e,{count:t});s&&(s.collapse(!1),n.removeAllRanges(),n.addRange(s))}}static getEndPosition(e){let t=0;const n=document.getSelection();if(n&&n.rangeCount>0){let s=n.getRangeAt(0),i=s.cloneRange();i.selectNodeContents(e),i.setEnd(s.endContainer,s.endOffset),t=i.toString().length}return t}static getBeginPosition(e){let t=0;const n=document.getSelection();if(n&&n.rangeCount>0){let s=n.getRangeAt(0),i=s.cloneRange();i.selectNodeContents(e),i.setEnd(s.startContainer,s.startOffset),t=i.toString().length}return t}}class f{constructor(e=0){this.size=e,this.stack=[]}push(e){this.stack.push(e),this.size>=1&&(this.stack=this.stack.slice(-this.size))}get(e){return e<0?this.stack[this.stack.length+e]:this.stack[e]}}class y{constructor(e,t,...n){this.name=e,this.verbosity=t,this.fcts=n}}const b={DEBUG:new y("DEBUG",6,console.debug),INFO:new y("INFO",5,console.info),LOG:new y("LOG",4,console.log),WARN:new y("WARN",3,console.warn),ERROR:new y("ERROR",2,console.error),CRITICAL:new y("CRITICAL",1,console.error)},w=window.location.origin,v=new f(1e3);class E{static has(){return e.isDebug()}static entry(e,t,...n){let s=null;t&&t.stack&&(s=t.stack.toString().split(/\r\n|\n/)[1].replace(w,""));const i=class{static full(){const e=new Date;return`${e.getFullYear()}.${e.getMonth()+1}.${e.getDate()}-${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`}static day(){const e=new Date;return`${e.getFullYear()}.${e.getMonth()+1}.${e.getDate()}`}}.full();if(v.push([i,e,s,n]),E.has()||e.verbosity<=2)for(const t of e.fcts)t(`${i} - ${e.name} - ${s} - `,...n)}static debug(...e){E.entry(b.DEBUG,new Error,...e)}static info(...e){E.entry(b.INFO,new Error,...e)}static log(...e){E.entry(b.LOG,new Error,...e)}static warn(...e){E.entry(b.WARN,new Error,...e)}static error(...e){E.entry(b.ERROR,new Error,...e)}static critical(...e){E.entry(b.CRITICAL,new Error,...e)}}function k(e){return String(e).replaceAll("<","&lt;").replaceAll(">","&gt;")}class C{constructor(e,t){this.element=e,this.lang=t,this.pattern=l[t].concat(l.generic)}setLang(e){this.lang=e,this.pattern=l[e]|this.pattern}getLang(){return this.lang}getElement(){return this.element}getPattern(){return this.pattern}apply(){const e=new g(this.pattern);this.element.innerHTML=e.refract(k(this.element.innerText)).replaceAll("\n",""),""===this.element.innerHTML.replaceAll("\n","")&&(this.element.innerHTML="<br>")}ApplyWithCaret(){const e=m.getBeginPosition(this.element);this.apply(),m.setPosition(this.element,e)}static onCurrent(e){return new C(s("uuid"),e)}}class L{constructor(e){this.editable=e,this.history=new f(2),this.change=!1,this.getAll()}hasChange(){return this.change}select(e){return document.querySelector(`[uuid='${e}']`)}getAll(){let e=[];for(let t of this.editable.children)t.hasAttribute("uuid")?e.push({uuid:t.getAttribute("uuid"),content:t.innerText.replaceAll("\n","")}):E.error("Error when trying to get all content of lines: ",t," has no UUID attribute.");return this.history.push(e),e}update(e,t){let n=this.select(e);n?(n.innerText=k(t),new C(n,"python").apply()):E.warn(`Error when trying to update element with uuid '${e}': No div has this uuid.`)}new(e,t,n){if(this.select(e))E.warn(`Children with uuid ${e} still exist.`);else{const s=this.select(t);s.parentNode.insertBefore(function(e,t,n){const s=document.createElement("div");s.innerHTML=t;for(const[e,t]of Object.entries(n))s.setAttribute(e,t);return s}(0,n+"<br>",{uuid:e}),s.nextSibling)}}remove(e){let t=this.select(e);t?t.remove():E.warn(`The element with uuid '${e}' can't be removed: it doesn't exist.`)}decompose(e){let t=[],n={};for(const s of e)t.push(s.uuid),n[s.uuid]=s.content;return[t,n]}getDiff(e){const[t,n]=this.decompose(this.history.get(-2)),[s,i]=this.decompose(this.history.get(-1));let r=[];for(const[s,i]of this.history.get(-1).entries())t.includes(i.uuid)?n[i.uuid]===i.content||i.uuid in e&&e[i.uuid]===i.content||r.push(["set",[i.uuid,i.content]]):i.uuid in e?r.push(["set",[i.uuid,i.content]]):r.push(["new",[i.uuid,this.history.get(-1)[s-1].uuid,i.content]]);for(const e of this.history.get(-2))s.includes(e.uuid)||r.push(["delete",[e.uuid]]);return r}}class x{static setLine(e,t){return{type:"set-line",data:{id:e,content:t}}}static newLine(e,t,n){return{type:"new-line",data:{id:e,previous:t,content:n}}}static deleteLine(e){return{type:"delete-line",data:{id:e}}}static save(e){return{type:"save",data:e}}}class S{constructor(e,t=1,n=null){this.element=e,this.set(t,n),console.log(this)}set(e,t=null){this.type=e,this.setSize(t),console.log(this)}setSize(e){0===this.type?(this.size=e,this.size||(this.size=8),this.element.style.tabSize=this.size+"px"):1===this.type?(this.size=e,this.size||(this.size=4),console.log(this.size,e),this.element.style.tabSize=2*this.size+"px"):(this.size=e,this.element.style.tabSize="inherit")}get(){return 1===this.type?" ".repeat(this.size):0===this.type?"\t":void 0}getCompletion(e){return 1===this.type?" ".repeat(this.size-e%this.size):0===this.type?"\t":void 0}getCompletionSize(e){return 1===this.type?this.size-e%this.size:1}}new class{constructor(e,t=1e3){this.doc_id=e,this.socket=io(),this.join(),this.stack={"update text":[]},this.preprocess=[],this.socket.on("text updated",(e=>{for(const t of e.requests){E.debug("RECEIVE",t.type,t.data);const n=e.room,s=new CustomEvent("socket.receive."+t.type,{detail:{request:t,room:n}});document.dispatchEvent(s)}})),document.addEventListener("socket.send",(e=>{e.detail.hasOwnProperty("request")&&this.stack["update text"].push(e.detail.request),e.detail.hasOwnProperty("requests")&&this.stack["update text"].push(...e.detail.requests)})),document.addEventListener("socket.send_now",(e=>{this.send(e.detail.name,e.detail.requests)})),document.addEventListener("socket.preprocess",(e=>{const t=e.detail[0];let n=e.detail[1];if(void 0===t)return;void 0===n&&(n=[]);const s=[t,n];this.preprocess.includes(s)||(this.preprocess.push(s),E.debug("New socket.preprocess",s))})),setInterval((()=>{for(const e of this.preprocess)e[0](...e[1]);this.stack["update text"].length&&this.send("update text",this.stack["update text"].splice(0,this.stack["update text"].length))}),t)}send(t,n){if(e.isDebug()&&Array.isArray(n))for(const e of n)E.debug("SEND to '"+t+"' with type '"+e.type+"'",e.data);this.socket.emit(t,{room:this.doc_id,requests:n})}join(){this.send("join",{room:this.doc_id})}}(doc_id),new class{constructor(e){this.editable=e,this.tab=new S(e,1,2),this.linesManager=new L(e),this.last_request={},this.keepSpace=!1,r.triggerCustom("socket.preprocess",[this.coroutine,[this]]),this.editable.addEventListener("keyup",(e=>{if(!u.isExtra(e.keyCode)){switch(e.keyCode){case 13:try{this.keepSpace=!1;let e=s("uuid"),t=e.previousElementSibling,n=o.string(10);e.setAttribute("uuid",n);let i=t.innerText.search(/\S/);i<0&&(i=0),t.innerText.trimEnd().endsWith(":")&&(i+=this.tab.getCompletionSize(i)),e.innerHTML=" ".repeat(i)+e.innerHTML,m.setPosition(e,i),0===e.innerText.length&&(e.innerHTML="<br>")}catch(e){E.error("Error when trying to customize the new line")}break;default:e.ctrlKey||e.altKey||C.onCurrent("python").ApplyWithCaret()}this.linesManager.change=!0}})),this.editable.addEventListener("paste",(e=>{const t=document.getSelection();let n=(e.clipboardData||window.clipboardData).getData("text");if(n){const s=n.split("\n");!function(e){return!!i(["div","section"]).hasAttribute("uuid")&&i(["div","section"],t.anchorNode)===i(["div","section"],t.focusNode)&&(1===e.length||t.anchorNode===t.focusNode&&t.anchorOffset===t.focusOffset)}(s)?(e.preventDefault(),E.debug("Prevent action when trying to paste on multiple line."),a("Paste Event","Sorry, you can't past over a multiline selection",5e3)):s.length>1&&(e.preventDefault(),this.multilinesInsert(s))}else e.preventDefault(),E.warn("Error when trying to get the content of your clipboard."),a("Paste Event","Error with content of your clipboard",5e3)})),this.editable.addEventListener("keydown",(e=>{if(u.ctrl(e)&&83===e.keyCode)return e.preventDefault(),void a("Save","Your document is still saved automatically",5e3,"#228b22");if(u.isExtra(e.keyCode))return;const t=document.getSelection(),n=i(["div","section"],t.anchorNode),r=i(["div","section"],t.focusNode),o=s("uuid");if(o){if(!n.hasAttribute("uuid")||!r.hasAttribute("uuid")||(0===m.getBeginPosition(o)||0===m.getEndPosition(o))&&n!==r)return e.preventDefault(),void a("Override","Sorry, you can't override the first char of a line",5e3);switch(e.keyCode){case 9:e.preventDefault(),this.insertTab();break;case 13:this.keepSpace?(E.debug("Prevent action when trying to add new line (key is probably maintain)."),e.preventDefault()):this.keepSpace=!0;break;case 8:0===m.getBeginPosition(o)&&(e.preventDefault(),this.removeLine(o))}}})),document.addEventListener("socket.receive.set-line",(e=>{const t=e.detail.request.data.id,n=e.detail.request.data.content;this.last_request[t]=n,this.linesManager.update(t,n)})),document.addEventListener("socket.receive.new-line",(e=>{const t=e.detail.request.data.id,n=e.detail.request.data.previous,s=e.detail.request.data.content;this.last_request[t]=s,this.linesManager.new(t,n,s)})),document.addEventListener("socket.receive.delete-line",(e=>{const t=e.detail.request.data.id;t in this.last_request&&delete this.last_request[t],this.linesManager.remove(t)}))}insertTab(){document.getSelection().collapseToStart(),document.getSelection().getRangeAt(0).insertNode(document.createTextNode(this.tab.getCompletion(m.getBeginPosition(s("uuid"))))),document.getSelection().collapseToEnd(),C.onCurrent("python").ApplyWithCaret()}multilinesInsert(e){const t=s("uuid");var n,i,r;t.innerHTML=(n=t.innerText,i=e[0],r=m.getBeginPosition(t),n.slice(0,r)+i+n.slice(r)),C.onCurrent("python").apply();let a=t.getAttribute("uuid");for(let t=1;t<e.length;t++){let n=o.string(10);this.linesManager.new(n,a,e[t]),new C(this.editable.querySelector('div[uuid="'+n+'"]'),"python").apply(),a=n}}removeLine(e){let t=e.previousSibling;for(;t&&1!==t.nodeType;)t=t.previousSibling;if(null!==t){const n=t.innerText.length;t.innerHTML+=e.innerHTML,e.remove(),m.setPosition(t,n)}}coroutine(e){if(e.linesManager.hasChange()){e.linesManager.getAll();const t=e.makeRequestsForDiff();r.triggerCustom("socket.send",{requests:t}),e.linesManager.change=!1}}makeRequestsForDiff(e=this.linesManager.getDiff(this.last_request)){let t=[];for(const n of e)switch(n[0]){case"set":t.push(x.setLine(...n[1]));break;case"new":t.push(x.newLine(...n[1]));break;case"delete":t.push(x.deleteLine(...n[1]))}return t}}(t.id("editor")),new class{constructor(e){this.editor=e,this.current=new Map,this.color=o.randInt(0,255,3),this.uuid=o.string(10),this.request={},document.addEventListener("socket.receive.cursor-moves",(e=>{this.update(e)})),document.dispatchEvent(new CustomEvent("socket.preprocess",{detail:[this.sendCursorPosition,[this]]})),this.editor.addEventListener("focus",(()=>{n()!==this.editor&&(this.request=this.cursorRequest())})),this.editor.addEventListener("click",(()=>{n()!==this.editor&&(this.request=this.cursorRequest())})),this.editor.addEventListener("keypress",(()=>{n()!==this.editor&&(this.request=this.cursorRequest())}))}cursorRequest(){let e=s("uuid");for(const t of this.current.entries())if(t[0]!==this.uuid&&t[1][1]===e)return{};return e.hasAttribute("uuid")?{type:"cursor-moves",data:{uuid:e.getAttribute("uuid"),userId:this.uuid,color:this.color}}:{}}sendCursorPosition(e){const t=e.request;e&&Object.keys(t).length>0&&(r.triggerCustom("socket.send",{request:t}),e.request={})}update(n){const s=n.detail.request.data;this.current.has(s.userId)&&(this.current.get(s.userId)[0].remove(),this.current.get(s.userId)[1].removeAttribute("contenteditable"),this.current.get(s.userId)[1].classList.remove("noteditable"),this.current.delete(s.userId));const i=document.querySelector('div[uuid="'+s.uuid+'"]');if(null===i)return void(e.isDebug()&&console.log("Cursor position doesn't exist"));const r=document.createElement("div");r.classList.add("pointer"),r.style.top=i.offsetTop+"px",r.style.backgroundColor="rgb("+s.color[0]+", "+s.color[1]+", "+s.color[2]+")",e.isDebug()&&(r.id=o.string(20)),t.id("body").appendChild(r),i.setAttribute("contenteditable","false"),i.classList.add("noteditable"),setTimeout((()=>{this.current.has(s.userId)&&Date.now()-this.current.get(s.userId)[2]>9e3&&(this.current.get(s.userId)[0].remove(),this.current.get(s.userId)[1].removeAttribute("contenteditable"),this.current.get(s.userId)[1].classList.remove("noteditable"),this.current.delete(s.userId))}),1e4),this.current.set(s.userId,[r,i,Date.now()])}}(t.id("editor"));for(const e of t.id("editor").children)new C(e,"python").ApplyWithCaret();var A,T;A=t.id("download"),T=t.id("editor"),A.addEventListener("click",(()=>{const e=T.innerText.replaceAll("\n\n","\n");A.setAttribute("href","data:Content-type, "+escape(e))}))})();